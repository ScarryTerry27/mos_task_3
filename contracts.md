# API Contracts

Документ описывает контракты фронтенда с backend-сервисом. Для каждой ручки указаны назначение, права доступа, структура запросов
и ответов, ограничения полей и возможные ошибки. Все даты/времена возвращаются в формате ISO 8601, если не указано иное.

## Общие правила
- **Базовый URL:** `/`.
- **Формат ответов:** JSON, кроме ручек загрузки файлов (multipart/form-data).
- **Идентификаторы:** положительные целые числа (`int > 0`).
- **Поля-списки:** возвращаются как массивы JSON.
- **Поля Enum:** передаются строками из перечисленных значений.
- **Строковые ограничения:** приведены по длинам SQL-колонок (в символах). Если длина не ограничена (тип `Text`), указывается `не ограничено`.
- **Статусы HTTP 422:** возможны при любом несоответствии телу схемы (неверный тип, обязательное поле отсутствует, некорректный Enum и т.д.).

### Перечисления
| Enum | Допустимые значения |
| --- | --- |
| `RoleEnum` | `contractor`, `inspector`, `admin` |
| `StatusEnum` | `Выполнено`, `В работе`, `Не начато`, `Приостановлено` |
| `CheckStatusEnum` | `Проверка пройдена`, `Инцидент` |
| `PrescriptionTypeEnum` | `Тип 1`, `Тип 2` |
| `DocTypeEnum` | `ТТН`, `output` |

---

## Сервис здоровья
### `GET /`
- **Назначение:** Проверка доступности сервиса.
- **Доступ:** Без авторизации.
- **Ответ 200:**
  | Поле | Тип | Ограничения | Описание |
  | --- | --- | --- | --- |
  | `status` | `string` | фиксированное значение `"ok"` | Статус приложения |

---

## Аутентификация (`/auth`)
### `POST /auth/register`
- **Назначение:** Создать нового пользователя.
- **Доступ:** Открыт.
- **Тело запроса:**
  | Поле | Тип | Обяз. | Ограничения | Описание |
  | --- | --- | --- | --- | --- |
  | `name` | `string` | да | 1–100 символов; уникально | Имя пользователя |
  | `role` | `string` | да | Enum `RoleEnum` | Роль пользователя |
  | `password` | `string` | да | 1–100 символов | Пароль в открытом виде |
- **Ответ 201:**
  | Поле | Тип | Ограничения | Описание |
  | --- | --- | --- | --- |
  | `user_id` | `int` | >0 | Идентификатор пользователя |
  | `name` | `string` | 1–100 символов | Имя пользователя |
  | `role` | `string` | Enum `RoleEnum` | Назначенная роль |
- **Ошибки:**
  - `400 User already exists` — `name` не уникально.

### `POST /auth/login`
- **Назначение:** Аутентификация пользователя.
- **Тело запроса:**
  | Поле | Тип | Обяз. | Ограничения |
  | --- | --- | --- | --- |
  | `name` | `string` | да | 1–100 символов |
  | `password` | `string` | да | 1–100 символов |
- **Ответ 200:** тело как при регистрации.
- **Ошибки:**
  - `401 Invalid credentials` — неверная пара `name`/`password`.

### `POST /auth/forgot-password`
- **Назначение:** Сбросить пароль пользователя.
- **Тело запроса:**
  | Поле | Тип | Обяз. | Ограничения |
  | --- | --- | --- | --- |
  | `name` | `string` | да | 1–100 символов |
  | `new_password` | `string` | да | 1–100 символов |
- **Ответ 200:** обновлённый пользователь (как в регистрации).
- **Ошибки:**
  - `404 User not found` — пользователь отсутствует.
  - `500 Unable to update password` — внутренняя ошибка при сохранении.

---

## Объекты (`/objects`)
> Текущая реализация `get_current_user()` возвращает администратора, однако фронт должен учитывать реальные проверки ролей, описанные ниже.

### `POST /objects`
- **Назначение:** Создать объект строительства.
- **Доступ:** Только `admin`.
- **Тело запроса:**
  | Поле | Тип | Обяз. | Ограничения | Описание |
  | --- | --- | --- | --- | --- |
  | `name` | `string` | да | 1–200 символов | Название объекта |
  | `status` | `string` | нет | Enum `StatusEnum`; по умолчанию `Не начато` | Текущий статус |
  | `address` | `string`\|`null` | нет | 0–300 символов | Адрес |
  | `admin_id` | `int` | да | >0; должен существовать | Ответственный администратор |
  | `inspector_id` | `int` | да | >0; должен существовать | Назначенный инспектор |
  | `contractor_id` | `int` | да | >0; должен существовать | Подрядчик |
- **Ответ 201:** объект с полями из запроса плюс `object_id`.
- **Ошибки:**
  - `403 Insufficient permissions` — роль не `admin`.
  - `404 <Role> not found` — один из переданных пользователей отсутствует.

### `GET /objects`
- **Назначение:** Получить список объектов с пагинацией.
- **Доступ:** Любая аутентифицированная роль. `admin` видит все объекты, `inspector` — только закреплённые, `contractor` — только свои.
- **Query-параметры:**
  | Параметр | Тип | По умолчанию | Ограничения | Описание |
  | --- | --- | --- | --- | --- |
  | `limit` | `int` | `100` | ≥1 | Максимум записей |
  | `offset` | `int` | `0` | ≥0 | Смещение |
- **Ответ 200:** массив объектов (структура как в `POST /objects`).

### `GET /objects/{object_id}`
- **Назначение:** Получить объект по ID.
- **Доступ:**
  - `admin` — без ограничений.
  - `inspector` — только если совпадает `inspector_id`.
  - `contractor` — только если совпадает `contractor_id`.
- **Ответ 200:** объект.
- **Ошибки:**
  - `404 Object not found` — объект отсутствует.
  - `403 Insufficient permissions` — доступ к чужому объекту.

### `PUT /objects/{object_id}`
- **Назначение:** Обновить объект.
- **Доступ:** Только `admin`.
- **Тело запроса:** любые подмножества полей из `POST /objects`; обязательные поля становятся опциональными. При передаче ID пользователей они проверяются на существование.
- **Ответ 200:** обновлённый объект.
- **Ошибки:**
  - `403 Insufficient permissions` — роль не `admin`.
  - `404 Object not found` — объект отсутствует.
  - `404 <Role> not found` — передан несуществующий пользователь.

### `DELETE /objects/{object_id}`
- **Назначение:** Удалить объект.
- **Доступ:** Только `admin`.
- **Ответ 204:** без тела.
- **Ошибки:**
  - `403 Insufficient permissions` — роль не `admin`.
  - `404 Object not found` — объект отсутствует.

---

## Субобъекты (`/subobjects`)
### `POST /subobjects`
- **Назначение:** Создать субобъект.
- **Доступ:** Только `admin`.
- **Тело запроса:**
  | Поле | Тип | Обяз. | Ограничения | Описание |
  | --- | --- | --- | --- | --- |
  | `name` | `string` | да | 1–200 символов | Название субобъекта |
  | `object_id` | `int` | да | >0; объект должен существовать | Родительский объект |
  | `status_inspector` | `string`\|`null` | нет | Enum `StatusEnum`; null допустимо; по умолчанию `Не начато` | Статус инспектора |
  | `status_contractor` | `string`\|`null` | нет | Enum `StatusEnum`; null допустимо; по умолчанию `Не начато` | Статус подрядчика |
  | `status_admin` | `string`\|`null` | нет | Enum `StatusEnum`; null допустимо; по умолчанию `Не начато` | Статус администратора |
  | `prescription_info` | `string`\|`null` | нет | не ограничено | Дополнительные предписания |
- **Ответ 201:** созданный субобъект (`subobject_id`, все поля запроса).
- **Ошибки:**
  - `403 Insufficient permissions` — роль не `admin`.
  - `404 Object not found` — `object_id` отсутствует или недоступен.

### `GET /subobjects`
- **Назначение:** Получить список субобъектов с пагинацией.
- **Доступ:**
  - `admin` — все записи.
  - `inspector` и `contractor` — только связанные через их объекты.
- **Query-параметры:** такие же, как для `/objects` (`limit` ≥1, `offset` ≥0).
- **Ответ 200:** массив субобъектов.

### `GET /subobjects/{subobject_id}`
- **Назначение:** Получить конкретный субобъект.
- **Доступ:** как для списка (через связь с объектом).
- **Ответ 200:** субобъект.
- **Ошибки:**
  - `404 Subobject not found` — субобъект отсутствует или объект удалён.
  - `403 Insufficient permissions` — чужой объект для инспектора/подрядчика.

### `PUT /subobjects/{subobject_id}`
- **Назначение:** Обновить субобъект.
- **Доступ и разрешённые поля:**
  - `admin` — любые поля.
  - `inspector` — только `status_inspector`.
  - `contractor` — только `status_contractor`.
- **Тело запроса:** опциональные поля из `POST /subobjects`. Поле `object_id` в текущей схеме обязательно (даже если не меняется) и
  должно ссылаться на существующий объект.
- **Ответ 200:** обновлённый субобъект.
- **Ошибки:**
  - `403 Insufficient permissions` — попытка изменить недоступное поле или не та роль.
  - `404 Subobject not found` — субобъект отсутствует.
  - `404 Object not found` — передан несуществующий `object_id`.

### `DELETE /subobjects/{subobject_id}`
- **Назначение:** Удалить субобъект.
- **Доступ:** Только `admin`.
- **Ответ 204:** без тела.
- **Ошибки:** `403 Insufficient permissions`, `404 Subobject not found`.

---

## Проверки (`/checks`)
### `POST /checks`
- **Назначение:** Создать проверку субобъекта.
- **Доступ:** `admin` и `inspector`.
- **Тело запроса:**
  | Поле | Тип | Обяз. | Ограничения | Описание |
  | --- | --- | --- | --- | --- |
  | `subobject_id` | `int` | да | >0; субобъект должен существовать и быть доступным | Целевой субобъект |
  | `location` | `string`\|`null` | нет | не ограничено | Локация |
  | `info` | `string`\|`null` | нет | не ограничено | Описание проверки |
  | `status_check` | `string`\|`null` | нет | Enum `CheckStatusEnum`; null допустимо; по умолчанию `null` | Результат проверки |
- **Ответ 201:**
  | Поле | Тип | Описание |
  | --- | --- | --- |
  | `check_id` | `int` | Уникальный идентификатор |
  | `subobject_id` | `int` | Связь с субобъектом |
  | `location` | `string`\|`null` | Локация |
  | `info` | `string`\|`null` | Описание |
  | `status_check` | `string`\|`null` | Статус проверки |
  | `datetime` | `string (datetime)` | Время создания |
- **Ошибки:**
  - `403 Insufficient permissions` — роль не разрешена или нет доступа к субобъекту.
  - `404 Subobject not found` — отсутствует или недоступен.

### `GET /checks`
- **Назначение:** Получить список проверок.
- **Доступ:**
  - `admin` — все проверки.
  - `inspector` — только связанные с его объектами.
- **Ответ 200:** массив проверок (структура как выше).

### `GET /checks/{check_id}`
- **Назначение:** Получить проверку.
- **Ответ 200:** проверка.
- **Ошибки:**
  - `404 Check not found` — запись отсутствует.
  - `403 Insufficient permissions` — нет доступа к субобъекту.

### `PUT /checks/{check_id}`
- **Назначение:** Обновить проверку.
- **Доступ:** `admin` и `inspector` (с учётом привязки к субобъекту).
- **Тело запроса:** опциональные поля из `POST /checks`; `subobject_id` при передаче должен быть доступным.
- **Ответ 200:** обновлённая проверка.
- **Ошибки:**
  - `403 Insufficient permissions` — нет доступа к проверке/субобъекту.
  - `404 Check not found` — проверка или субобъект отсутствуют.

### `DELETE /checks/{check_id}`
- **Назначение:** Удалить проверку.
- **Доступ:** Только `admin`.
- **Ответ 204:** без тела.
- **Ошибки:** `403 Insufficient permissions`, `404 Check not found`.

### `POST /checks/process-video`
- **Назначение:** Загрузить видео инспектором и автоматически создать проверку + связанные инциденты.
- **Доступ:** Только `inspector` (с доступом к субобъекту).
- **Тип контента:** `multipart/form-data`.
- **Поля формы:**
  | Поле | Тип | Обяз. | Ограничения |
  | --- | --- | --- | --- |
  | `subobject_id` | `int` | да | >0; субобъект должен существовать и быть доступным |
  | `video` | файл | да | MIME: `video/mp4`, `video/mpeg`, `video/quicktime`; размер ограничивается сервером/облачным провайдером |
- **Ответ 201:**
  - `check` — объект проверки (как `POST /checks`).
  - `incidents` — массив инцидентов (структура из `POST /incidents` + `incident_id`, `date`).
    | Поле | Тип | Ограничения | Описание |
    | --- | --- | --- | --- |
    | `incident_id` | `int` | >0 | Идентификатор созданного инцидента |
    | `check_id` | `int` | >0 | Связь с проверкой |
    | `photo` | `string`\|`null` | не ограничено | Ссылка на фото |
    | `incident_status` | `boolean`\|`null` | — | Статус инцидента |
    | `incident_info` | `string`\|`null` | не ограничено | Описание |
    | `prescription_type` | `string`\|`null` | Enum `PrescriptionTypeEnum`; null допустимо | Тип предписания |
    | `date` | `string (datetime)` | — | Дата создания |
- **Ошибки:**
  - `403 Insufficient permissions` — роль не инспектор или нет доступа.
  - `400 Invalid file` — неподдерживаемый формат или `subobject_id ≤ 0`.
  - `404 Subobject not found` — субобъект отсутствует или недоступен.

---

## Инциденты (`/incidents`)
### `POST /incidents`
- **Назначение:** Создать инцидент, связанный с проверкой.
- **Доступ:** Предполагается `admin`/`inspector` (должно соответствовать политике приложения).
- **Тело запроса:**
  | Поле | Тип | Обяз. | Ограничения | Описание |
  | --- | --- | --- | --- | --- |
  | `check_id` | `int` | да | >0; проверка должна существовать | Связанная проверка |
  | `photo` | `string`\|`null` | нет | не ограничено | URL/путь к фото |
  | `incident_status` | `boolean`\|`null` | нет | — | Флаг устранения/актуальности |
  | `incident_info` | `string`\|`null` | нет | не ограничено | Описание |
  | `prescription_type` | `string`\|`null` | нет | Enum `PrescriptionTypeEnum`; null допустимо | Тип предписания |
- **Ответ 201:** инцидент + поля `incident_id` (>0) и `date` (datetime).

### `GET /incidents`
- **Назначение:** Список инцидентов.
- **Ответ 200:** массив инцидентов.

### `GET /incidents/{incident_id}`
- **Назначение:** Получить инцидент.
- **Ответ 200:** инцидент.
- **Ошибки:** `404 Incident not found`.

### `PUT /incidents/{incident_id}`
- **Назначение:** Обновить инцидент.
- **Тело запроса:** опциональные поля из `POST /incidents`; `check_id` при передаче должен существовать.
- **Ответ 200:** обновлённый инцидент.
- **Ошибки:** `404 Incident not found`.

### `DELETE /incidents/{incident_id}`
- **Назначение:** Удалить инцидент.
- **Ответ 204:** без тела.
- **Ошибки:** `404 Incident not found`.

---

## Документы (`/documents`)
### `POST /documents`
- **Назначение:** Создать документ.
- **Тело запроса:**
  | Поле | Тип | Обяз. | Ограничения | Описание |
  | --- | --- | --- | --- | --- |
  | `user_id` | `int` | да | >0; пользователь должен существовать | Ответственный пользователь |
  | `object_id` | `int` | да | >0; объект должен существовать | Связанный объект |
  | `doc_type` | `string` | да | Enum `DocTypeEnum` | Тип документа |
  | `doc_number` | `string` | да | 1–50 символов | Номер документа |
  | `doc_date_start` | `string (date)` | да | формат `YYYY-MM-DD` | Дата начала/создания |
  | `doc_date_end` | `string (date)` | да | формат `YYYY-MM-DD`; рекомендуется ≥ `doc_date_start` | Дата окончания |
  | `doc_image_id` | `string` | да | 1–100 символов | Идентификатор файла в сторидже |
- **Ответ 201:** документ + `document_id` (>0).
- **Ошибки:**
  - `404 User not found`/`Object not found` — должны обрабатываться на бекенде, но фронту стоит ожидать.

### `GET /documents`
- **Назначение:** Получить список документов.
- **Ответ 200:** массив документов (структура как выше + `document_id`).

### `GET /documents/{document_id}`
- **Назначение:** Получить документ.
- **Ответ 200:** документ.
- **Ошибки:** `404 Document not found`.

### `PUT /documents/{document_id}`
- **Назначение:** Обновить документ.
- **Тело запроса:** опциональные поля из `POST /documents`. Любые переданные ID должны существовать. Даты должны быть валидными.
- **Ответ 200:** обновлённый документ.
- **Ошибки:** `404 Document not found`.

### `DELETE /documents/{document_id}`
- **Назначение:** Удалить документ (ожидается роль `admin`).
- **Ответ 204:** без тела.
- **Ошибки:** `404 Document not found`.

### `POST /documents/process-photo`
- **Назначение:** Загрузить фото документа для автоматического распознавания документа и материалов.
- **Тип контента:** `multipart/form-data`.
- **Поля формы:**
  | Поле | Тип | Обяз. | Ограничения |
  | --- | --- | --- | --- |
  | `user_id` | `int` | да | >0; пользователь должен существовать |
  | `object_id` | `int` | да | >0; объект должен существовать |
  | `photo` | файл | да | MIME: `image/jpeg`, `image/png`; `image/jpg` допустимо |
- **Ответ 201:**
  - `document` — как `POST /documents` + `document_id`.
  - `materials` — массив материалов (см. ниже) с `material_id`.
    | Поле | Тип | Ограничения | Описание |
    | --- | --- | --- | --- |
    | `material_id` | `int` | >0 | Идентификатор |
    | `doc_id` | `int` | >0 | Связь с документом |
    | `name` | `string` | 1–200 символов | Наименование |
    | `okpd` | `string`\|`null` | 0–50 символов | Код ОКПД |
    | `amount` | `number` | тип `float`; рекомендуется ≥0 | Количество |
    | `uom` | `string` | 1–20 символов | Ед. измерения |
    | `to_be_certified` | `boolean` | — | Требуется сертификация |
    | `certificate` | `string`\|`null` | не ограничено | Сертификат |
- **Ошибки:**
  - `400 Invalid file` — неподдерживаемый формат.

---

## Материалы (`/materials`)
### `POST /materials`
- **Назначение:** Создать материал, связанный с документом.
- **Тело запроса:**
  | Поле | Тип | Обяз. | Ограничения | Описание |
  | --- | --- | --- | --- | --- |
  | `doc_id` | `int` | да | >0; документ должен существовать | Связанный документ |
  | `name` | `string` | да | 1–200 символов | Наименование материала |
  | `okpd` | `string`\|`null` | нет | 0–50 символов | Код ОКПД |
  | `amount` | `number` | да | тип `float`; рекомендуется ≥0 | Количество |
  | `uom` | `string` | да | 1–20 символов | Единица измерения |
  | `to_be_certified` | `boolean` | да | — | Требуется сертификат |
  | `certificate` | `string`\|`null` | нет | не ограничено | Номер/ссылка на сертификат |
- **Ответ 201:** материал + `material_id` (>0).

### `GET /materials`
- **Назначение:** Получить список материалов.
- **Ответ 200:** массив материалов.

### `GET /materials/{material_id}`
- **Назначение:** Получить материал.
- **Ответ 200:** материал.
- **Ошибки:** `404 Material not found`.

### `PUT /materials/{material_id}`
- **Назначение:** Обновить материал.
- **Тело запроса:** опциональные поля из `POST /materials`; при передаче `doc_id` документ должен существовать.
- **Ответ 200:** обновлённый материал.
- **Ошибки:** `404 Material not found`.

### `DELETE /materials/{material_id}`
- **Назначение:** Удалить материал (ожидается роль `admin`).
- **Ответ 204:** без тела.
- **Ошибки:** `404 Material not found`.

---

## Общие рекомендации по обработке ошибок
- Любая ручка может вернуть `500 Internal Server Error` в случае непредвиденной ошибки сервера.
- При валидационных ошибках FastAPI возвращает `422 Unprocessable Entity` с описанием проблемы.
- При работе с файлами рекомендуется проверять размер до отправки, чтобы избежать отклонения на уровне reverse-proxy.
