# API Contracts

Этот документ описывает контракты фронтенда с backend-сервисом. Для каждой ручки указаны метод, URL, назначение, параметры запроса, ожидаемые тела запросов и ответы, а также возможные ошибки. Все схемы ссылочные и соответствуют моделям из `services/db/schema.py`.

## Общие сведения
- Базовый URL сервиса: `/`.
- Все ответы возвращаются в формате JSON, если не указано иное.
- Поля перечислений (`Enum`) в телах запросов и ответов передаются строками.

## Сервис здоровья
### `GET /`
- **Назначение:** Проверка доступности сервиса.
- **Ответ 200:**
  ```json
  { "status": "ok" }
  ```

## Аутентификация (`/auth`)
### `POST /auth/register`
- **Назначение:** Создать нового пользователя.
- **Тело запроса:**
  ```json
  {
    "name": "string",
    "role": "contractor" | "inspector" | "admin",
    "password": "string"
  }
  ```
- **Ответ 201:** Объект пользователя.
  ```json
  {
    "user_id": 1,
    "name": "string",
    "role": "contractor" | "inspector" | "admin"
  }
  ```
- **Ошибки:**
  - 400 — пользователь с таким `name` уже существует.

### `POST /auth/login`
- **Назначение:** Аутентификация пользователя.
- **Тело запроса:**
  ```json
  {
    "name": "string",
    "password": "string"
  }
  ```
- **Ответ 200:** Объект пользователя (как в регистрации).
- **Ошибки:**
  - 401 — неверные учетные данные.

### `POST /auth/forgot-password`
- **Назначение:** Сбросить пароль пользователя.
- **Тело запроса:**
  ```json
  {
    "name": "string",
    "new_password": "string"
  }
  ```
- **Ответ 200:** Обновленный пользователь.
- **Ошибки:**
  - 404 — пользователь не найден.
  - 500 — не удалось обновить пароль.

## Объекты (`/objects`)
> Доступ ограничен. Функции `get_current_user()` пока возвращают администратора, но фронтенду нужно закладываться на реальные проверки ролей.

### `POST /objects`
- **Назначение:** Создать объект (только роль `admin`).
- **Тело запроса:**
  ```json
  {
    "name": "string",
    "status": "Выполнено" | "В работе" | "Не начато" | "Приостановлено",
    "address": "string|null",
    "admin_id": 1,
    "inspector_id": 2,
    "contractor_id": 3
  }
  ```
- **Ответ 201:** Созданный объект.
  ```json
  {
    "object_id": 10,
    "name": "string",
    "status": "В работе",
    "address": "string|null",
    "admin_id": 1,
    "inspector_id": 2,
    "contractor_id": 3
  }
  ```
- **Ошибки:**
  - 403 — недостаточно прав.
  - 404 — один из переданных пользователей (`admin_id`/`inspector_id`/`contractor_id`) не найден.

### `GET /objects`
- **Назначение:** Получить список объектов.
- **Параметры запроса:**
  - `limit` (query, int ≥1, по умолчанию 100)
  - `offset` (query, int ≥0, по умолчанию 0)
- **Ответ 200:** Список объектов (массив как в примере выше).
- **Особенности:** Админ получает все записи; инспектор/подрядчик — только привязанные объекты.

### `GET /objects/{object_id}`
- **Назначение:** Получить объект по ID.
- **Ответ 200:** Объект.
- **Ошибки:**
  - 404 — объект не найден.
  - 403 — нет доступа (для инспектора/подрядчика к чужому объекту).

### `PUT /objects/{object_id}`
- **Назначение:** Обновить объект (только `admin`).
- **Тело запроса:** Любые поля из:
  ```json
  {
    "name": "string",
    "status": "Выполнено" | "В работе" | "Не начато" | "Приостановлено",
    "address": "string|null",
    "admin_id": 1,
    "inspector_id": 2,
    "contractor_id": 3
  }
  ```
- **Ответ 200:** Обновленный объект.
- **Ошибки:**
  - 403 — недостаточно прав.
  - 404 — объект не найден или указанные пользователи не существуют.

### `DELETE /objects/{object_id}`
- **Назначение:** Удалить объект (только `admin`).
- **Ответ 204:** Без тела.
- **Ошибки:**
  - 403 — недостаточно прав.
  - 404 — объект не найден.

## Субобъекты (`/subobjects`)
### `POST /subobjects`
- **Назначение:** Создать субобъект (только `admin`).
- **Тело запроса:**
  ```json
  {
    "name": "string",
    "object_id": 10,
    "status_inspector": "Выполнено" | "В работе" | "Не начато" | "Приостановлено" | null,
    "status_contractor": "Выполнено" | "В работе" | "Не начато" | "Приостановлено" | null,
    "status_admin": "Выполнено" | "В работе" | "Не начато" | "Приостановлено" | null,
    "prescription_info": "string|null"
  }
  ```
- **Ответ 201:** Созданный субобъект.
- **Ошибки:**
  - 403 — недостаточно прав.
  - 404 — объект с `object_id` не найден.

### `GET /subobjects`
- **Назначение:** Получить список субобъектов.
- **Параметры:** `limit`, `offset` аналогично `/objects`.
- **Ответ 200:** Массив субобъектов.
- **Особенности:** Фильтрация по ролям аналогична объектам.

### `GET /subobjects/{subobject_id}`
- **Назначение:** Получить субобъект.
- **Ответ 200:** Субобъект.
- **Ошибки:**
  - 404 — субобъект или связанный объект не найден.
  - 403 — инспектор/подрядчик пытается получить доступ к чужому объекту.

### `PUT /subobjects/{subobject_id}`
- **Назначение:** Обновить субобъект.
- **Права:**
  - `admin` — любые поля.
  - `inspector` — только `status_inspector`.
  - `contractor` — только `status_contractor`.
- **Тело запроса:** Любое подмножество полей из:
  ```json
  {
    "name": "string",
    "status_inspector": "Выполнено" | "В работе" | "Не начато" | "Приостановлено" | null,
    "status_contractor": "Выполнено" | "В работе" | "Не начато" | "Приостановлено" | null,
    "status_admin": "Выполнено" | "В работе" | "Не начато" | "Приостановлено" | null,
    "prescription_info": "string|null",
    "object_id": 10
  }
  ```
- **Ответ 200:** Обновленный субобъект.
- **Ошибки:**
  - 403 — попытка изменить запрещенные поля или недостаточно прав.
  - 404 — субобъект или объект не найден.

### `DELETE /subobjects/{subobject_id}`
- **Назначение:** Удалить субобъект (только `admin`).
- **Ответ 204:** Без тела.
- **Ошибки:** 403, 404.

## Проверки (`/checks`)
### `POST /checks`
- **Назначение:** Создать проверку (доступно `admin` и `inspector`).
- **Тело запроса:**
  ```json
  {
    "subobject_id": 1,
    "location": "string|null",
    "info": "string|null",
    "status_check": "Проверка пройдена" | "Инцидент" | null
  }
  ```
- **Ответ 201:** Созданная проверка, включая `check_id` и `datetime` (ISO8601).
- **Ошибки:**
  - 403 — недостаточно прав.
  - 404 — субобъект не найден или нет доступа к нему.

### `GET /checks`
- **Назначение:** Список проверок (`admin` — все, `inspector` — свои).
- **Ответ 200:** Массив проверок.
- **Ошибки:** 403 — недостаточно прав.

### `GET /checks/{check_id}`
- **Назначение:** Получить проверку.
- **Ответ 200:** Проверка.
- **Ошибки:**
  - 404 — проверка не найдена.
  - 403 — нет доступа к связанному субобъекту.

### `PUT /checks/{check_id}`
- **Назначение:** Обновить проверку (`admin`/`inspector`).
- **Тело запроса:** Любые поля из:
  ```json
  {
    "location": "string|null",
    "info": "string|null",
    "status_check": "Проверка пройдена" | "Инцидент" | null,
    "subobject_id": 1
  }
  ```
- **Ответ 200:** Обновленная проверка.
- **Ошибки:**
  - 403 — недостаточно прав или нет доступа к субобъекту.
  - 404 — проверка или субобъект не найдены.

### `DELETE /checks/{check_id}`
- **Назначение:** Удалить проверку (только `admin`).
- **Ответ 204:** Без тела.
- **Ошибки:**
  - 403 — недостаточно прав.
  - 404 — проверка не найдена.

### `POST /checks/process-video`
- **Назначение:** Загрузить видео инспектором и сохранить результаты анализа.
- **Тип контента:** `multipart/form-data`.
- **Поля формы:**
  - `subobject_id` — число (>0).
  - `video` — файл (`video/mp4`, `video/mpeg`, `video/quicktime`).
- **Ответ 201:**
  ```json
  {
    "check": {
      "check_id": 1,
      "subobject_id": 1,
      "location": "string|null",
      "info": "string|null",
      "status_check": "Проверка пройдена" | "Инцидент" | null,
      "datetime": "2024-01-01T12:00:00"
    },
    "incidents": [
      {
        "incident_id": 1,
        "check_id": 1,
        "photo": "string|null",
        "incident_status": true,
        "incident_info": "string|null",
        "prescription_type": "Тип 1" | "Тип 2" | null,
        "date": "2024-01-01T12:00:00"
      }
    ]
  }
  ```
- **Ошибки:**
  - 403 — доступ разрешен только инспектору.
  - 400 — `subobject_id` ≤ 0 или неподдерживаемый тип файла.
  - 404 — субобъект недоступен/не найден.

## Инциденты (`/incidents`)
### `POST /incidents`
- **Назначение:** Создать инцидент.
- **Тело запроса:**
  ```json
  {
    "check_id": 1,
    "photo": "string|null",
    "incident_status": true,
    "incident_info": "string|null",
    "prescription_type": "Тип 1" | "Тип 2" | null
  }
  ```
- **Ответ 201:** Созданный инцидент, включая `incident_id` и `date` (ISO8601).

### `GET /incidents`
- **Назначение:** Получить список инцидентов.
- **Ответ 200:** Массив инцидентов.

### `GET /incidents/{incident_id}`
- **Назначение:** Получить инцидент.
- **Ответ 200:** Инцидент.
- **Ошибки:** 404 — не найден.

### `PUT /incidents/{incident_id}`
- **Назначение:** Обновить инцидент.
- **Тело запроса:** Любые поля из тела создания.
- **Ответ 200:** Обновленный инцидент.
- **Ошибки:** 404 — не найден.

### `DELETE /incidents/{incident_id}`
- **Назначение:** Удалить инцидент.
- **Ответ 204:** Без тела.
- **Ошибки:** 404 — не найден.

## Документы (`/documents`)
### `POST /documents`
- **Назначение:** Создать документ.
- **Тело запроса:**
  ```json
  {
    "user_id": 1,
    "object_id": 10,
    "doc_type": "ТТН" | "output",
    "doc_number": "string",
    "doc_date_start": "YYYY-MM-DD",
    "doc_date_end": "YYYY-MM-DD",
    "doc_image_id": "string"
  }
  ```
- **Ответ 201:** Созданный документ.
- **Ошибки:** 404 — пользователь или объект не найдены (должно быть реализовано на бэке, но фронту стоит ожидать).

### `GET /documents`
- **Назначение:** Получить список документов.
- **Ответ 200:** Массив документов.

### `GET /documents/{document_id}`
- **Назначение:** Получить документ.
- **Ответ 200:** Документ.
- **Ошибки:** 404 — не найден.

### `PUT /documents/{document_id}`
- **Назначение:** Обновить документ.
- **Тело запроса:** Любые поля из тела создания.
- **Ответ 200:** Обновленный документ.
- **Ошибки:** 404 — не найден.

### `DELETE /documents/{document_id}`
- **Назначение:** Удалить документ (ожидается только для `admin`).
- **Ответ 204:** Без тела.
- **Ошибки:** 404 — не найден.

### `POST /documents/process-photo`
- **Назначение:** Загрузить фото для автоматического разбора документа и материалов.
- **Тип контента:** `multipart/form-data`.
- **Поля формы:**
  - `user_id` — идентификатор пользователя.
  - `object_id` — идентификатор объекта.
  - `photo` — файл (`image/jpeg`, `image/png`, `image/jpg`).
- **Ответ 201:**
  ```json
  {
    "document": {
      "document_id": 1,
      "user_id": 1,
      "object_id": 10,
      "doc_type": "ТТН" | "output",
      "doc_number": "string",
      "doc_date_start": "YYYY-MM-DD",
      "doc_date_end": "YYYY-MM-DD",
      "doc_image_id": "string"
    },
    "materials": [
      {
        "material_id": 1,
        "doc_id": 1,
        "name": "string",
        "okpd": "string|null",
        "amount": 100.0,
        "uom": "string",
        "to_be_certified": true,
        "certificate": "string|null"
      }
    ]
  }
  ```
- **Ошибки:**
  - 400 — неподдерживаемый формат файла.

## Материалы (`/materials`)
### `POST /materials`
- **Назначение:** Создать материал.
- **Тело запроса:**
  ```json
  {
    "doc_id": 1,
    "name": "string",
    "okpd": "string|null",
    "amount": 100.0,
    "uom": "string",
    "to_be_certified": true,
    "certificate": "string|null"
  }
  ```
- **Ответ 201:** Созданный материал.

### `GET /materials`
- **Назначение:** Получить список материалов.
- **Ответ 200:** Массив материалов.

### `GET /materials/{material_id}`
- **Назначение:** Получить материал.
- **Ответ 200:** Материал.
- **Ошибки:** 404 — не найден.

### `PUT /materials/{material_id}`
- **Назначение:** Обновить материал.
- **Тело запроса:** Любые поля из тела создания.
- **Ответ 200:** Обновленный материал.
- **Ошибки:** 404 — не найден.

### `DELETE /materials/{material_id}`
- **Назначение:** Удалить материал (ожидается, что доступ ограничен ролью `admin`).
- **Ответ 204:** Без тела.
- **Ошибки:** 404 — не найден.

